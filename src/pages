// pages/DashboardPage.tsx
import { useParams, useNavigate, Link } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel, getCompletedLessons } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { ProgressBar } from "../components/ProgressBar"
import { CEFR_LEVELS } from "../types"

interface SectionCardProps {
    emoji: string
    title: string
    description: string
    to: string
    progress?: number
}

function SectionCard({ emoji, title, description, to, progress }: SectionCardProps) {
    return (
        <Link
            to={to}
            className="bg-white border border-gray-200 rounded-2xl p-5 hover:border-indigo-400
                       hover:shadow-md transition-all flex flex-col gap-2"
        >
            <span className="text-3xl">{emoji}</span>
            <p className="font-semibold text-gray-900">{title}</p>
            <p className="text-sm text-gray-500">{description}</p>
            {progress !== undefined && (
                <ProgressBar value={progress} className="mt-1" />
            )}
        </Link>
    )
}

export function DashboardPage() {
    const { langId = "" } = useParams()
    const navigate = useNavigate()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)
    const completed = getCompletedLessons(langId)

    if (!language || !mod) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <p className="text-gray-500">Language not found.</p>
            </div>
        )
    }

    const grammarItems = mod.grammar.filter(g => g.level === level)
    const vocabItems   = mod.vocab.filter(v => v.level === level)
    const verbItems    = mod.verbs.filter(v => v.level === level)

    const grammarDone = grammarItems.filter(g => completed.includes(g.id)).length
    const vocabDone   = vocabItems.filter(v => completed.includes(v.id)).length
    const verbDone    = verbItems.filter(v => completed.includes(v.id)).length

    const grammarPct = grammarItems.length ? (grammarDone / grammarItems.length) * 100 : 0
    const vocabPct   = vocabItems.length   ? (vocabDone   / vocabItems.length)   * 100 : 0
    const verbPct    = verbItems.length    ? (verbDone    / verbItems.length)    * 100 : 0

    const levelIndex = CEFR_LEVELS.indexOf(level)
    const canAdvance = levelIndex < CEFR_LEVELS.length - 1

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title={`${language.flag} ${language.name}`} level={level} backTo="/languages" />

            <main className="max-w-3xl mx-auto px-4 py-8">
                {/* Level header */}
                <div className="bg-white rounded-2xl border border-gray-200 p-5 mb-6 flex items-center gap-4">
                    <div className="text-4xl">{language.flag}</div>
                    <div className="flex-1">
                        <p className="text-sm text-gray-500 mb-1">Current level</p>
                        <div className="flex items-center gap-2">
                            <LevelBadge level={level} />
                            <span className="text-gray-700 text-sm">
                                {level === "A1" && "Beginner"}
                                {level === "A2" && "Elementary"}
                                {level === "B1" && "Intermediate"}
                                {level === "B2" && "Upper Intermediate"}
                                {level === "C1" && "Advanced"}
                            </span>
                        </div>
                    </div>
                    <button
                        onClick={() => navigate(`/learn/${langId}/placement`)}
                        className="text-xs text-indigo-600 hover:underline shrink-0"
                    >
                        Change level
                    </button>
                </div>

                {/* Content sections */}
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Study</h3>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <SectionCard
                        emoji="üìñ"
                        title="Grammar"
                        description={`${grammarItems.length} lessons at ${level}`}
                        to={`/learn/${langId}/grammar`}
                        progress={grammarPct}
                    />
                    <SectionCard
                        emoji="üìù"
                        title="Vocabulary"
                        description={`${vocabItems.length} words at ${level}`}
                        to={`/learn/${langId}/vocab`}
                        progress={vocabPct}
                    />
                    <SectionCard
                        emoji="üî§"
                        title="Verbs"
                        description={`${verbItems.length} verbs at ${level}`}
                        to={`/learn/${langId}/verbs`}
                        progress={verbPct}
                    />
                </div>

                {/* Practice */}
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Practice</h3>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <SectionCard
                        emoji="üÉè"
                        title="Flashcards"
                        description="Flip cards to drill vocabulary"
                        to={`/learn/${langId}/flashcards`}
                    />
                    <SectionCard
                        emoji="üî°"
                        title="Verb Drill"
                        description="Pick the right conjugation"
                        to={`/learn/${langId}/verb-drill`}
                    />
                    <SectionCard
                        emoji="‚úèÔ∏è"
                        title="Grammar Drill"
                        description="Match sentences by meaning"
                        to={`/learn/${langId}/grammar-drill`}
                    />
                </div>

                {/* Level test */}
                {canAdvance && (
                    <>
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Progress</h3>
                        <div
                            className="bg-indigo-50 border border-indigo-200 rounded-2xl p-5 flex
                                       items-center justify-between gap-4 cursor-pointer hover:bg-indigo-100 transition-colors"
                            onClick={() => navigate(`/learn/${langId}/level-test`)}
                        >
                            <div>
                                <p className="font-semibold text-indigo-900">Level Test</p>
                                <p className="text-sm text-indigo-700">
                                    Pass 12/15 questions to advance to {CEFR_LEVELS[levelIndex + 1]}
                                </p>
                            </div>
                            <span className="text-2xl">üéØ</span>
                        </div>
                    </>
                )}
            </main>
        </div>
    )
}





















// pages/GrammarPage.tsx
import { useState } from "react"
import { useParams } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel, getCompletedLessons, markLessonComplete } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { GrammarLesson } from "../types"

function LessonCard({
    lesson,
    done,
    langId,
    onComplete,
}: {
    lesson: GrammarLesson
    done: boolean
    langId: string
    onComplete: () => void
}) {
    const [open, setOpen] = useState(false)

    return (
        <div className={`bg-white border rounded-2xl overflow-hidden transition-all ${done ? "border-green-300" : "border-gray-200"}`}>
            {/* Header */}
            <button
                onClick={() => setOpen(o => !o)}
                className="w-full px-5 py-4 flex items-center gap-3 text-left"
            >
                <span className={`text-lg ${done ? "text-green-500" : "text-gray-300"}`}>
                    {done ? "‚úì" : "‚óã"}
                </span>
                <span className="flex-1 font-medium text-gray-900">{lesson.title}</span>
                <LevelBadge level={lesson.level} />
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className={`w-4 h-4 text-gray-400 transition-transform ${open ? "rotate-180" : ""}`}
                    fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}
                >
                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            {/* Body */}
            {open && (
                <div className="px-5 pb-5 border-t border-gray-100">
                    <p className="text-sm text-gray-700 mt-4 leading-relaxed">{lesson.explanation}</p>

                    <div className="mt-4 flex flex-col gap-3">
                        {lesson.examples.map((ex, i) => (
                            <div key={i} className="bg-gray-50 rounded-xl p-3">
                                <p className="font-medium text-gray-900">{ex.native}</p>
                                {ex.romanized && (
                                    <p className="text-xs text-indigo-500 mt-0.5">{ex.romanized}</p>
                                )}
                                <p className="text-sm text-gray-500 mt-0.5">{ex.translation}</p>
                            </div>
                        ))}
                    </div>

                    {!done && (
                        <button
                            onClick={() => { markLessonComplete(langId, lesson.id); onComplete() }}
                            className="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold
                                       rounded-xl py-2 text-sm transition-colors"
                        >
                            Mark as complete
                        </button>
                    )}
                </div>
            )}
        </div>
    )
}

export function GrammarPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)
    const [completed, setCompleted] = useState(() => getCompletedLessons(langId))

    if (!language || !mod) return null

    const lessons = mod.grammar.filter(g => g.level === level)
    const coming  = lessons.length === 0

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar
                title="Grammar"
                level={level}
                backTo={`/learn/${langId}`}
            />
            <main className="max-w-3xl mx-auto px-4 py-6">
                <div className="flex items-center gap-2 mb-6">
                    <h2 className="text-xl font-bold text-gray-900">Grammar</h2>
                    <LevelBadge level={level} />
                    <span className="text-sm text-gray-500 ml-1">
                        {completed.filter(id => lessons.some(l => l.id === id)).length} / {lessons.length} complete
                    </span>
                </div>

                {coming ? (
                    <div className="text-center py-16 text-gray-400">
                        <p className="text-4xl mb-3">üöß</p>
                        <p className="font-medium">Content coming soon for {level}</p>
                    </div>
                ) : (
                    <div className="flex flex-col gap-3">
                        {lessons.map(lesson => (
                            <LessonCard
                                key={lesson.id}
                                lesson={lesson}
                                done={completed.includes(lesson.id)}
                                langId={langId}
                                onComplete={() => setCompleted(getCompletedLessons(langId))}
                            />
                        ))}
                    </div>
                )}
            </main>
        </div>
    )
}






















// pages/LanguageSelectPage.tsx
import { useNavigate } from "react-router-dom"
import { LANGUAGES } from "../data/languages"
import { setSelectedLanguage } from "../store/progress"
import { useAuth } from "../auth/AuthContext"

export function LanguageSelectPage() {
    const { logout } = useAuth()
    const navigate = useNavigate()

    function pick(langId: string) {
        setSelectedLanguage(langId)
        navigate(`/learn/${langId}`)
    }

    return (
        <div className="min-h-screen bg-gray-50">
            <header className="bg-white border-b border-gray-200">
                <div className="max-w-3xl mx-auto px-4 h-14 flex items-center justify-between">
                    <span className="font-semibold text-gray-900">Language Study</span>
                    <button onClick={logout} className="text-sm text-gray-500 hover:text-gray-800">
                        Sign out
                    </button>
                </div>
            </header>

            <main className="max-w-3xl mx-auto px-4 py-10">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">Choose a language</h2>
                <p className="text-gray-500 mb-8">Select a language to start or continue learning.</p>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {LANGUAGES.map(lang => (
                        <button
                            key={lang.id}
                            onClick={() => pick(lang.id)}
                            className="bg-white border border-gray-200 rounded-2xl p-5 flex items-center gap-4
                                       hover:border-indigo-400 hover:shadow-md transition-all text-left"
                        >
                            <span className="text-4xl">{lang.flag}</span>
                            <div>
                                <p className="font-semibold text-gray-900 text-lg">{lang.name}</p>
                                <p className="text-sm text-gray-500">{lang.nativeName}</p>
                            </div>
                        </button>
                    ))}
                </div>
            </main>
        </div>
    )
}





















// pages/LevelTestPage.tsx
import { useState } from "react"
import { useParams, useNavigate } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel, setCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { QuizCard } from "../components/QuizCard"
import { LevelBadge } from "../components/LevelBadge"
import { CEFR_LEVELS, CEFRLevel } from "../types"

const PASS_THRESHOLD = 12  // out of 15

export function LevelTestPage() {
    const { langId = "" } = useParams()
    const navigate = useNavigate()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)

    const [current, setCurrent]   = useState(0)
    const [selected, setSelected] = useState<string | null>(null)
    const [revealed, setRevealed] = useState(false)
    const [score, setScore]       = useState(0)
    const [done, setDone]         = useState(false)

    if (!language || !mod) return null

    const questions = mod.levelQuestions.filter(q => q.level === level)

    if (questions.length === 0) {
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Level Test" level={level} backTo={`/learn/${langId}`} />
                <main className="max-w-xl mx-auto px-4 py-16 text-center text-gray-400">
                    <p className="text-4xl mb-3">üöß</p>
                    <p className="font-medium">Level test coming soon for {level}</p>
                </main>
            </div>
        )
    }

    function handleSelect(opt: string) {
        setSelected(opt)
        setRevealed(true)
    }

    function handleNext() {
        const newScore = score + (selected === questions[current].answer ? 1 : 0)
        if (current + 1 >= questions.length) {
            setScore(newScore)
            setDone(true)
        } else {
            setScore(newScore)
            setCurrent(c => c + 1)
            setSelected(null)
            setRevealed(false)
        }
    }

    if (done) {
        const passed = score >= PASS_THRESHOLD
        const levelIndex = CEFR_LEVELS.indexOf(level)
        const nextLevel = passed && levelIndex < CEFR_LEVELS.length - 1
            ? CEFR_LEVELS[levelIndex + 1] as CEFRLevel
            : null

        function handleAdvance() {
            if (nextLevel) setCurrentLevel(langId, nextLevel)
            navigate(`/learn/${langId}`)
        }

        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Level Test" level={level} backTo={`/learn/${langId}`} />
                <main className="max-w-xl mx-auto px-4 py-12 flex flex-col items-center gap-6 text-center">
                    <div className="text-5xl">{passed ? "üèÜ" : "üìö"}</div>
                    <h2 className="text-2xl font-bold text-gray-900">
                        {passed ? "Level passed!" : "Keep practising!"}
                    </h2>
                    <p className="text-gray-600">
                        You answered <strong>{score}</strong> out of <strong>{questions.length}</strong> correctly.
                        {" "}({Math.round((score / questions.length) * 100)}%)
                    </p>

                    <div className="bg-white rounded-2xl border border-gray-200 p-5 w-full">
                        {passed && nextLevel ? (
                            <>
                                <p className="text-sm text-gray-500 mb-3">You can now advance to</p>
                                <div className="flex justify-center mb-4">
                                    <LevelBadge level={nextLevel} />
                                </div>
                                <button
                                    onClick={handleAdvance}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                               rounded-xl py-2.5 text-sm transition-colors"
                                >
                                    Advance to {nextLevel}
                                </button>
                            </>
                        ) : passed ? (
                            <>
                                <p className="text-sm text-gray-600 mb-4">
                                    Congratulations ‚Äî you've reached the highest level!
                                </p>
                                <button
                                    onClick={() => navigate(`/learn/${langId}`)}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                               rounded-xl py-2.5 text-sm transition-colors"
                                >
                                    Back to dashboard
                                </button>
                            </>
                        ) : (
                            <>
                                <p className="text-sm text-gray-600 mb-1">
                                    You need <strong>{PASS_THRESHOLD}</strong> correct answers to advance.
                                </p>
                                <p className="text-xs text-gray-400 mb-4">
                                    Review grammar, vocabulary, and verbs and try again when you're ready.
                                </p>
                                <button
                                    onClick={() => navigate(`/learn/${langId}`)}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                               rounded-xl py-2.5 text-sm transition-colors mb-2"
                                >
                                    Back to dashboard
                                </button>
                                <button
                                    onClick={() => {
                                        setCurrent(0); setScore(0)
                                        setSelected(null); setRevealed(false); setDone(false)
                                    }}
                                    className="w-full border border-indigo-300 text-indigo-700 font-semibold
                                               rounded-xl py-2.5 text-sm transition-colors hover:bg-indigo-50"
                                >
                                    Try again
                                </button>
                            </>
                        )}
                    </div>
                </main>
            </div>
        )
    }

    const q = questions[current]

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Level Test" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-xl mx-auto px-4 py-8 flex flex-col items-center gap-6">
                <div className="w-full flex items-center justify-between text-sm text-gray-500">
                    <span>Question {current + 1} of {questions.length}</span>
                    <span className="font-medium">Score: {score}</span>
                </div>

                {/* Progress strip */}
                <div className="w-full flex gap-1">
                    {questions.map((_, i) => (
                        <div
                            key={i}
                            className={`h-1.5 flex-1 rounded-full transition-colors ${
                                i < current ? "bg-indigo-500" :
                                i === current ? "bg-indigo-300" :
                                "bg-gray-200"
                            }`}
                        />
                    ))}
                </div>

                <QuizCard
                    question={q.prompt}
                    options={q.options}
                    selected={selected}
                    correct={revealed ? q.answer : null}
                    onSelect={handleSelect}
                />

                {revealed && (
                    <button
                        onClick={handleNext}
                        className="w-full max-w-xl bg-indigo-600 hover:bg-indigo-700 text-white
                                   font-semibold rounded-xl py-3 transition-colors"
                    >
                        {current + 1 >= questions.length ? "See results" : "Next question"}
                    </button>
                )}
            </main>
        </div>
    )
}























// pages/LoginPage.tsx
import { useState, FormEvent } from "react"
import { Link, useNavigate, useLocation } from "react-router-dom"
import { useAuth } from "../auth/AuthContext"
import { getSelectedLanguage } from "../store/progress"

export function LoginPage() {
    const { login } = useAuth()
    const navigate = useNavigate()
    const location = useLocation()
    const lastLang = getSelectedLanguage()
    const defaultDest = lastLang ? `/learn/${lastLang}` : "/languages"
    const from = (location.state as { from?: { pathname: string } })?.from?.pathname ?? defaultDest

    const [email, setEmail]       = useState("")
    const [password, setPassword] = useState("")
    const [error, setError]       = useState<string | null>(null)
    const [loading, setLoading]   = useState(false)

    async function handleSubmit(e: FormEvent) {
        e.preventDefault()
        setError(null)
        if (!email || !password) { setError("Please fill in all fields."); return }
        setLoading(true)
        try {
            await login(email, password)
            navigate(from, { replace: true })
        } catch (err) {
            setError(err instanceof Error ? err.message : "Login failed.")
        } finally {
            setLoading(false)
        }
    }

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center px-4">
            <div className="w-full max-w-sm">
                <h1 className="text-3xl font-bold text-center text-gray-900 mb-2">Language Study</h1>
                <p className="text-center text-gray-500 mb-8">Sign in to continue</p>

                <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4">
                    {error && (
                        <p className="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2">
                            {error}
                        </p>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input
                            type="email"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="you@example.com"
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            autoComplete="email"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            autoComplete="current-password"
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60 text-white font-semibold rounded-lg py-2.5 text-sm transition-colors"
                    >
                        {loading ? "Signing in‚Ä¶" : "Sign in"}
                    </button>
                </form>

                <p className="text-center text-sm text-gray-500 mt-4">
                    No account?{" "}
                    <Link to="/register" className="text-indigo-600 hover:underline font-medium">
                        Create one
                    </Link>
                </p>
            </div>
        </div>
    )
}























// pages/PlacementPage.tsx
import { useState } from "react"
import { useParams, useNavigate } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { setCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { QuizCard } from "../components/QuizCard"
import { LevelBadge } from "../components/LevelBadge"
import { CEFRLevel, CEFR_LEVELS } from "../types"

type Tab = "test" | "manual"

function scoreToLevel(score: number): CEFRLevel {
    if (score >= 9) return "B2"
    if (score >= 7) return "B1"
    if (score >= 5) return "A2"
    return "A1"
}

export function PlacementPage() {
    const { langId = "" } = useParams()
    const navigate = useNavigate()
    const language = getLanguage(langId)
    const mod = getModule(langId)

    const [tab, setTab]             = useState<Tab>("test")
    const [current, setCurrent]     = useState(0)
    const [selected, setSelected]   = useState<string | null>(null)
    const [revealed, setRevealed]   = useState(false)
    const [score, setScore]         = useState(0)
    const [done, setDone]           = useState(false)
    const [suggested, setSuggested] = useState<CEFRLevel>("A1")

    if (!language || !mod) return null

    const questions = mod.placementQuestions

    function handleSelect(opt: string) {
        setSelected(opt)
        setRevealed(true)
    }

    function handleNext() {
        const newScore = score + (selected === questions[current].answer ? 1 : 0)
        if (current + 1 >= questions.length) {
            const level = scoreToLevel(newScore)
            setSuggested(level)
            setScore(newScore)
            setDone(true)
        } else {
            setScore(newScore)
            setCurrent(c => c + 1)
            setSelected(null)
            setRevealed(false)
        }
    }

    function confirmLevel(level: CEFRLevel) {
        setCurrentLevel(langId, level)
        navigate(`/learn/${langId}`)
    }

    if (done) {
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title={`${language.flag} ${language.name}`} backTo={`/learn/${langId}`} />
                <main className="max-w-xl mx-auto px-4 py-12 flex flex-col items-center gap-6 text-center">
                    <div className="text-5xl">üéâ</div>
                    <h2 className="text-2xl font-bold text-gray-900">Placement complete!</h2>
                    <p className="text-gray-600">
                        You answered <strong>{score}</strong> out of <strong>{questions.length}</strong> correctly.
                    </p>
                    <div className="bg-white rounded-2xl border border-gray-200 p-5 w-full">
                        <p className="text-sm text-gray-500 mb-3">Suggested level</p>
                        <div className="flex justify-center mb-4">
                            <LevelBadge level={suggested} />
                        </div>
                        <button
                            onClick={() => confirmLevel(suggested)}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                       rounded-xl py-2.5 text-sm transition-colors mb-3"
                        >
                            Start at {suggested}
                        </button>
                        <p className="text-xs text-gray-400 mb-2">Or choose a different level:</p>
                        <div className="flex justify-center gap-2 flex-wrap">
                            {CEFR_LEVELS.map(l => (
                                <button
                                    key={l}
                                    onClick={() => confirmLevel(l)}
                                    className={`px-3 py-1 rounded-full text-sm font-medium border transition-colors
                                        ${l === suggested
                                            ? "border-indigo-500 bg-indigo-50 text-indigo-700"
                                            : "border-gray-300 text-gray-600 hover:border-indigo-400"}`}
                                >
                                    {l}
                                </button>
                            ))}
                        </div>
                    </div>
                </main>
            </div>
        )
    }

    const q = questions[current]

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title={`${language.flag} Placement Test`} backTo={`/learn/${langId}`} />
            <main className="max-w-xl mx-auto px-4 py-8 flex flex-col items-center gap-6">
                {tab === "test" ? (
                    <>
                        <div className="w-full flex items-center justify-between text-sm text-gray-500">
                            <span>Question {current + 1} of {questions.length}</span>
                            <button
                                onClick={() => setTab("manual")}
                                className="text-indigo-600 hover:underline"
                            >
                                Set level manually
                            </button>
                        </div>

                        {/* Progress strip */}
                        <div className="w-full flex gap-1">
                            {questions.map((_, i) => (
                                <div
                                    key={i}
                                    className={`h-1.5 flex-1 rounded-full transition-colors ${
                                        i < current ? "bg-indigo-500" :
                                        i === current ? "bg-indigo-300" :
                                        "bg-gray-200"
                                    }`}
                                />
                            ))}
                        </div>

                        <QuizCard
                            question={q.prompt}
                            options={q.options}
                            selected={selected}
                            correct={revealed ? q.answer : null}
                            onSelect={handleSelect}
                        />

                        {revealed && (
                            <button
                                onClick={handleNext}
                                className="w-full max-w-xl bg-indigo-600 hover:bg-indigo-700 text-white
                                           font-semibold rounded-xl py-3 transition-colors"
                            >
                                {current + 1 >= questions.length ? "See results" : "Next question"}
                            </button>
                        )}
                    </>
                ) : (
                    <div className="bg-white rounded-2xl border border-gray-200 p-6 w-full">
                        <h2 className="font-semibold text-gray-900 mb-2">Choose your level</h2>
                        <p className="text-sm text-gray-500 mb-5">
                            Select the CEFR level that best describes your current proficiency.
                        </p>
                        <div className="flex flex-col gap-3">
                            {CEFR_LEVELS.map(l => (
                                <button
                                    key={l}
                                    onClick={() => confirmLevel(l)}
                                    className="border border-gray-200 rounded-xl px-4 py-3 text-left
                                               hover:border-indigo-400 hover:bg-indigo-50 transition-colors"
                                >
                                    <span className="font-semibold text-gray-900 mr-2">{l}</span>
                                    <span className="text-sm text-gray-500">
                                        {l === "A1" && "Absolute beginner"}
                                        {l === "A2" && "Elementary"}
                                        {l === "B1" && "Intermediate"}
                                        {l === "B2" && "Upper intermediate"}
                                        {l === "C1" && "Advanced"}
                                    </span>
                                </button>
                            ))}
                        </div>
                        <button
                            onClick={() => setTab("test")}
                            className="mt-4 text-sm text-indigo-600 hover:underline"
                        >
                            Take the placement test instead
                        </button>
                    </div>
                )}
            </main>
        </div>
    )
}


























// pages/RegisterPage.tsx
import { useState, FormEvent } from "react"
import { Link, useNavigate } from "react-router-dom"
import { registerUser } from "../auth/mockAuthApi"
import { useAuth } from "../auth/AuthContext"

export function RegisterPage() {
    const { login } = useAuth()
    const navigate = useNavigate()

    const [name, setName]         = useState("")
    const [email, setEmail]       = useState("")
    const [password, setPassword] = useState("")
    const [error, setError]       = useState<string | null>(null)
    const [loading, setLoading]   = useState(false)

    async function handleSubmit(e: FormEvent) {
        e.preventDefault()
        setError(null)
        if (!name || !email || !password) { setError("Please fill in all fields."); return }
        if (password.length < 6) { setError("Password must be at least 6 characters."); return }

        setLoading(true)
        try {
            registerUser(email, name, password)
            await login(email, password)
            navigate("/languages", { replace: true })
        } catch (err) {
            setError(err instanceof Error ? err.message : "Registration failed.")
        } finally {
            setLoading(false)
        }
    }

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center px-4">
            <div className="w-full max-w-sm">
                <h1 className="text-3xl font-bold text-center text-gray-900 mb-2">Language Study</h1>
                <p className="text-center text-gray-500 mb-8">Create your account</p>

                <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4">
                    {error && (
                        <p className="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2">
                            {error}
                        </p>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input
                            type="text"
                            value={name}
                            onChange={e => setName(e.target.value)}
                            placeholder="Your name"
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            autoComplete="name"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input
                            type="email"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="you@example.com"
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            autoComplete="email"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            placeholder="Min. 6 characters"
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            autoComplete="new-password"
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60 text-white font-semibold rounded-lg py-2.5 text-sm transition-colors"
                    >
                        {loading ? "Creating account‚Ä¶" : "Create account"}
                    </button>
                </form>

                <p className="text-center text-sm text-gray-500 mt-4">
                    Already have an account?{" "}
                    <Link to="/login" className="text-indigo-600 hover:underline font-medium">
                        Sign in
                    </Link>
                </p>
            </div>
        </div>
    )
}






















// pages/VerbsPage.tsx
import { useParams } from "react-router-dom"
import { useState } from "react"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { Verb } from "../types"

function VerbCard({ verb }: { verb: Verb }) {
    const [open, setOpen] = useState(false)

    return (
        <div className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
            <button
                onClick={() => setOpen(o => !o)}
                className="w-full px-5 py-4 flex items-center gap-3 text-left"
            >
                <div className="flex-1">
                    <span className="font-semibold text-gray-900">{verb.infinitive}</span>
                    {verb.romanized && (
                        <span className="ml-2 text-xs text-indigo-500">{verb.romanized}</span>
                    )}
                    <span className="ml-2 text-sm text-gray-500">‚Äî {verb.meaning}</span>
                </div>
                <LevelBadge level={verb.level} />
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className={`w-4 h-4 text-gray-400 transition-transform shrink-0 ${open ? "rotate-180" : ""}`}
                    fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}
                >
                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            {open && (
                <div className="px-5 pb-5 border-t border-gray-100">
                    {verb.conjugations.map(conj => (
                        <div key={conj.tense} className="mt-4">
                            <p className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                                {conj.tense}
                            </p>
                            <div className="rounded-xl border border-gray-100 overflow-hidden">
                                {conj.forms.map((f, i) => (
                                    <div
                                        key={i}
                                        className={`flex items-center px-4 py-2.5 text-sm ${
                                            i % 2 === 0 ? "bg-white" : "bg-gray-50"
                                        }`}
                                    >
                                        <span className="text-gray-500 w-28 shrink-0">{f.pronoun}</span>
                                        <span className="font-medium text-gray-900">{f.form}</span>
                                        {f.romanized && (
                                            <span className="ml-2 text-xs text-indigo-400">{f.romanized}</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    )
}

export function VerbsPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)

    if (!language || !mod) return null

    const verbs = mod.verbs.filter(v => v.level === level)
    const coming = verbs.length === 0

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Verbs" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-3xl mx-auto px-4 py-6">
                <div className="flex items-center gap-2 mb-6">
                    <h2 className="text-xl font-bold text-gray-900">Verbs</h2>
                    <LevelBadge level={level} />
                    <span className="text-sm text-gray-500 ml-1">{verbs.length} verbs</span>
                </div>

                {coming ? (
                    <div className="text-center py-16 text-gray-400">
                        <p className="text-4xl mb-3">üöß</p>
                        <p className="font-medium">Content coming soon for {level}</p>
                    </div>
                ) : (
                    <div className="flex flex-col gap-3">
                        {verbs.map(verb => (
                            <VerbCard key={verb.id} verb={verb} />
                        ))}
                    </div>
                )}
            </main>
        </div>
    )
}






























// pages/VocabPage.tsx
import { useState } from "react"
import { useParams } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel, getCompletedLessons, markLessonComplete } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { VocabItem } from "../types"

function VocabCard({
    item,
    done,
    langId,
    onComplete,
}: {
    item: VocabItem
    done: boolean
    langId: string
    onComplete: () => void
}) {
    const [open, setOpen] = useState(false)

    return (
        <div
            className={`bg-white border rounded-2xl overflow-hidden transition-all cursor-pointer
                ${done ? "border-green-300" : "border-gray-200 hover:border-indigo-300"}`}
            onClick={() => setOpen(o => !o)}
        >
            <div className="px-4 py-3 flex items-center gap-3">
                <span className={`text-base ${done ? "text-green-500" : "text-gray-300"}`}>
                    {done ? "‚úì" : "‚óã"}
                </span>
                <div className="flex-1 min-w-0">
                    <span className="font-semibold text-gray-900">{item.word}</span>
                    {item.romanized && (
                        <span className="ml-2 text-xs text-indigo-500">{item.romanized}</span>
                    )}
                </div>
                <span className="text-sm text-gray-500 shrink-0">{item.translation}</span>
                <span className="text-xs bg-gray-100 text-gray-500 rounded-full px-2 py-0.5 shrink-0 hidden sm:block">
                    {item.category}
                </span>
            </div>

            {open && (
                <div className="px-4 pb-4 border-t border-gray-100 pt-3" onClick={e => e.stopPropagation()}>
                    <div className="bg-gray-50 rounded-xl p-3 mb-3">
                        <p className="text-sm font-medium text-gray-800">{item.example.native}</p>
                        {item.example.romanized && (
                            <p className="text-xs text-indigo-500 mt-0.5">{item.example.romanized}</p>
                        )}
                        <p className="text-xs text-gray-500 mt-1">{item.example.translation}</p>
                    </div>
                    {!done && (
                        <button
                            onClick={() => { markLessonComplete(langId, item.id); onComplete() }}
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold
                                       rounded-xl py-2 text-sm transition-colors"
                        >
                            Mark as learned
                        </button>
                    )}
                </div>
            )}
        </div>
    )
}

export function VocabPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)
    const [completed, setCompleted] = useState(() => getCompletedLessons(langId))
    const [filter, setFilter] = useState<"all" | "todo" | "done">("all")

    if (!language || !mod) return null

    const items = mod.vocab.filter(v => v.level === level)
    const filtered = items.filter(item => {
        if (filter === "done") return completed.includes(item.id)
        if (filter === "todo") return !completed.includes(item.id)
        return true
    })
    const doneCount = items.filter(i => completed.includes(i.id)).length
    const coming = items.length === 0

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Vocabulary" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-3xl mx-auto px-4 py-6">
                <div className="flex items-center gap-2 mb-4">
                    <h2 className="text-xl font-bold text-gray-900">Vocabulary</h2>
                    <LevelBadge level={level} />
                    <span className="text-sm text-gray-500 ml-1">
                        {doneCount} / {items.length} learned
                    </span>
                </div>

                {!coming && (
                    <div className="flex gap-2 mb-5">
                        {(["all", "todo", "done"] as const).map(f => (
                            <button
                                key={f}
                                onClick={() => setFilter(f)}
                                className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors capitalize
                                    ${filter === f
                                        ? "bg-indigo-600 text-white"
                                        : "bg-white border border-gray-200 text-gray-600 hover:border-indigo-400"}`}
                            >
                                {f}
                            </button>
                        ))}
                    </div>
                )}

                {coming ? (
                    <div className="text-center py-16 text-gray-400">
                        <p className="text-4xl mb-3">üöß</p>
                        <p className="font-medium">Content coming soon for {level}</p>
                    </div>
                ) : filtered.length === 0 ? (
                    <p className="text-center text-gray-400 py-12">No words match this filter.</p>
                ) : (
                    <div className="flex flex-col gap-2">
                        {filtered.map(item => (
                            <VocabCard
                                key={item.id}
                                item={item}
                                done={completed.includes(item.id)}
                                langId={langId}
                                onComplete={() => setCompleted(getCompletedLessons(langId))}
                            />
                        ))}
                    </div>
                )}
            </main>
        </div>
    )
}






// pages/ProfilePage.tsx
import { useState } from "react"
import { useNavigate } from "react-router-dom"
import { useAuth } from "../auth/AuthContext"
import { getUserById } from "../auth/mockAuthApi"
import { LANGUAGES } from "../data/languages"
import { getModule } from "../data/modules"
import {
    getStartedLanguages,
    getCurrentLevel,
    getCompletedLessons,
    resetLanguageProgress,
    setSelectedLanguage,
} from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { ProgressBar } from "../components/ProgressBar"

const LEVEL_LABEL: Record<string, string> = {
    A1: "Beginner", A2: "Elementary",
    B1: "Intermediate", B2: "Upper Intermediate", C1: "Advanced",
}

export function ProfilePage() {
    const { session, logout } = useAuth()
    const navigate = useNavigate()
    const [tick, setTick] = useState(0)   // force re-render after reset

    const userInfo = session ? getUserById(session.userId) : null
    const displayName = userInfo?.displayName ?? "User"
    const email       = userInfo?.email ?? ""
    const initials    = displayName.split(" ").map(w => w[0]).join("").slice(0, 2).toUpperCase()

    const startedIds = getStartedLanguages()
    const started    = LANGUAGES.filter(l => startedIds.includes(l.id))
    const notStarted = LANGUAGES.filter(l => !startedIds.includes(l.id))

    function handleContinue(langId: string) {
        setSelectedLanguage(langId)
        navigate(`/learn/${langId}`)
    }

    function handleReset(langId: string) {
        if (!confirm("Reset all progress for this language?")) return
        resetLanguageProgress(langId)
        setTick(t => t + 1)   // trigger re-render
    }

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Profile" />

            <main className="max-w-2xl mx-auto px-4 py-8">
                {/* User card */}
                <div className="bg-white rounded-2xl border border-gray-200 p-6 flex items-center gap-4 mb-8">
                    <div className="w-14 h-14 rounded-full bg-indigo-600 flex items-center justify-center
                                    text-white text-xl font-bold shrink-0">
                        {initials}
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="font-semibold text-gray-900 text-lg truncate">{displayName}</p>
                        <p className="text-sm text-gray-500 truncate">{email}</p>
                    </div>
                    <button
                        onClick={logout}
                        className="text-sm text-red-500 hover:text-red-700 shrink-0"
                    >
                        Sign out
                    </button>
                </div>

                {/* Languages in progress */}
                {started.length > 0 && (
                    <>
                        <h2 className="text-lg font-semibold text-gray-900 mb-4">Languages in progress</h2>
                        <div className="flex flex-col gap-4 mb-8">
                            {started.map(lang => {
                                const mod       = getModule(lang.id)
                                const level     = getCurrentLevel(lang.id)
                                const completed = getCompletedLessons(lang.id)
                                if (!mod) return null

                                const grammarItems = mod.grammar.filter(g => g.level === level)
                                const vocabItems   = mod.vocab.filter(v => v.level === level)
                                const verbItems    = mod.verbs.filter(v => v.level === level)

                                const grammarDone = grammarItems.filter(g => completed.includes(g.id)).length
                                const vocabDone   = vocabItems.filter(v => completed.includes(v.id)).length
                                const verbDone    = verbItems.filter(v => completed.includes(v.id)).length

                                return (
                                    <div key={lang.id + tick}
                                        className="bg-white rounded-2xl border border-gray-200 p-5">
                                        {/* Header row */}
                                        <div className="flex items-center gap-3 mb-4">
                                            <span className="text-3xl">{lang.flag}</span>
                                            <div className="flex-1">
                                                <p className="font-semibold text-gray-900">{lang.name}</p>
                                                <p className="text-xs text-gray-400">{lang.nativeName}</p>
                                            </div>
                                            <LevelBadge level={level} />
                                            <span className="text-xs text-gray-400">{LEVEL_LABEL[level]}</span>
                                        </div>

                                        {/* Progress bars */}
                                        <div className="flex flex-col gap-2 mb-4">
                                            <ProgressBar
                                                label={`Grammar  ${grammarDone}/${grammarItems.length}`}
                                                value={grammarItems.length ? (grammarDone / grammarItems.length) * 100 : 0}
                                            />
                                            <ProgressBar
                                                label={`Vocabulary  ${vocabDone}/${vocabItems.length}`}
                                                value={vocabItems.length ? (vocabDone / vocabItems.length) * 100 : 0}
                                            />
                                            <ProgressBar
                                                label={`Verbs  ${verbDone}/${verbItems.length}`}
                                                value={verbItems.length ? (verbDone / verbItems.length) * 100 : 0}
                                            />
                                        </div>

                                        {/* Actions */}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => handleContinue(lang.id)}
                                                className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white
                                                           font-semibold rounded-xl py-2 text-sm transition-colors"
                                            >
                                                Continue learning
                                            </button>
                                            <button
                                                onClick={() => handleReset(lang.id)}
                                                className="px-4 border border-gray-200 text-gray-500
                                                           hover:border-red-300 hover:text-red-500 rounded-xl
                                                           text-sm transition-colors"
                                            >
                                                Reset
                                            </button>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </>
                )}

                {/* Not started */}
                {notStarted.length > 0 && (
                    <>
                        <h2 className="text-lg font-semibold text-gray-900 mb-4">
                            {started.length === 0 ? "Available languages" : "Add a language"}
                        </h2>
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            {notStarted.map(lang => (
                                <button
                                    key={lang.id}
                                    onClick={() => handleContinue(lang.id)}
                                    className="bg-white border border-gray-200 rounded-2xl p-4 flex flex-col
                                               items-center gap-2 hover:border-indigo-400 hover:shadow-sm
                                               transition-all text-center"
                                >
                                    <span className="text-3xl">{lang.flag}</span>
                                    <p className="text-sm font-medium text-gray-800">{lang.name}</p>
                                </button>
                            ))}
                        </div>
                    </>
                )}
            </main>
        </div>
    )
}













// pages/FlashcardsPage.tsx
import { useState, useMemo } from "react"
import { useParams } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { LevelBadge } from "../components/LevelBadge"
import { VocabItem } from "../types"

function shuffle<T>(arr: T[]): T[] {
    return [...arr].sort(() => Math.random() - 0.5)
}

type Result = "correct" | "incorrect"

function FlipCard({ item, flipped, onClick }: {
    item: VocabItem
    flipped: boolean
    onClick: () => void
}) {
    return (
        <div className="card-scene w-full max-w-sm mx-auto" style={{ height: 220 }} onClick={onClick}>
            <div className={`card-inner relative w-full h-full cursor-pointer ${flipped ? "flipped" : ""}`}>
                {/* Front */}
                <div className="card-face absolute inset-0 bg-white rounded-2xl border-2 border-gray-200
                                flex flex-col items-center justify-center gap-2 p-6 shadow-md">
                    <p className="text-3xl font-bold text-gray-900 text-center">{item.word}</p>
                    {item.romanized && (
                        <p className="text-sm text-indigo-500">{item.romanized}</p>
                    )}
                    <p className="text-xs text-gray-400 mt-2">Tap to reveal</p>
                </div>

                {/* Back */}
                <div className="card-back card-face absolute inset-0 bg-indigo-50 rounded-2xl border-2
                                border-indigo-300 flex flex-col items-center justify-center gap-3 p-6 shadow-md">
                    <p className="text-2xl font-bold text-indigo-900 text-center">{item.translation}</p>
                    <div className="bg-white rounded-xl px-4 py-2 text-center">
                        <p className="text-sm text-gray-700">{item.example.native}</p>
                        {item.example.romanized && (
                            <p className="text-xs text-indigo-400 mt-0.5">{item.example.romanized}</p>
                        )}
                        <p className="text-xs text-gray-400 mt-0.5">{item.example.translation}</p>
                    </div>
                </div>
            </div>
        </div>
    )
}

export function FlashcardsPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)

    const cards = useMemo(() => shuffle(mod?.vocab.filter(v => v.level === level) ?? []), [langId, level])

    const [index, setIndex]     = useState(0)
    const [flipped, setFlipped] = useState(false)
    const [results, setResults] = useState<Result[]>([])
    const [done, setDone]       = useState(false)
    const [reviewMode, setReviewMode] = useState(false)
    const [reviewCards, setReviewCards] = useState<VocabItem[]>([])

    if (!language || !mod) return null

    const deck = reviewMode ? reviewCards : cards

    if (cards.length === 0) {
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Flashcards" level={level} backTo={`/learn/${langId}`} />
                <div className="flex flex-col items-center justify-center py-24 text-gray-400">
                    <p className="text-4xl mb-3">üöß</p>
                    <p className="font-medium">No vocabulary at {level} yet</p>
                </div>
            </div>
        )
    }

    function handleResult(r: Result) {
        const newResults = [...results, r]
        setResults(newResults)
        if (index + 1 >= deck.length) {
            setDone(true)
        } else {
            setIndex(i => i + 1)
            setFlipped(false)
        }
    }

    function startReview() {
        const missed = deck.filter((_, i) => results[i] === "incorrect")
        setReviewCards(missed)
        setIndex(0)
        setResults([])
        setFlipped(false)
        setDone(false)
        setReviewMode(true)
    }

    function restart() {
        setIndex(0)
        setResults([])
        setFlipped(false)
        setDone(false)
        setReviewMode(false)
    }

    // Results screen
    if (done) {
        const correct   = results.filter(r => r === "correct").length
        const incorrect = results.filter(r => r === "incorrect").length
        const pct = Math.round((correct / deck.length) * 100)

        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Flashcards" level={level} backTo={`/learn/${langId}`} />
                <main className="max-w-sm mx-auto px-4 py-12 flex flex-col items-center gap-6 text-center">
                    <div className="text-5xl">{pct >= 80 ? "üéâ" : "üí™"}</div>
                    <h2 className="text-2xl font-bold text-gray-900">
                        {reviewMode ? "Review complete!" : "Round complete!"}
                    </h2>
                    <div className="bg-white rounded-2xl border border-gray-200 p-5 w-full flex justify-around">
                        <div>
                            <p className="text-3xl font-bold text-green-600">{correct}</p>
                            <p className="text-xs text-gray-500 mt-1">Got it</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-red-500">{incorrect}</p>
                            <p className="text-xs text-gray-500 mt-1">Not yet</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-indigo-600">{pct}%</p>
                            <p className="text-xs text-gray-500 mt-1">Score</p>
                        </div>
                    </div>

                    <div className="flex flex-col gap-3 w-full">
                        {incorrect > 0 && (
                            <button
                                onClick={startReview}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                           rounded-xl py-2.5 text-sm transition-colors"
                            >
                                Review {incorrect} missed card{incorrect !== 1 ? "s" : ""}
                            </button>
                        )}
                        <button
                            onClick={restart}
                            className="w-full border border-gray-200 text-gray-700 hover:border-indigo-400
                                       font-semibold rounded-xl py-2.5 text-sm transition-colors"
                        >
                            Start over
                        </button>
                    </div>
                </main>
            </div>
        )
    }

    const card = deck[index]

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Flashcards" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-sm mx-auto px-4 py-8 flex flex-col items-center gap-6">
                {/* Progress */}
                <div className="w-full flex items-center justify-between text-sm text-gray-500">
                    <span>
                        {reviewMode && <span className="text-indigo-600 font-medium mr-2">Review</span>}
                        {index + 1} / {deck.length}
                    </span>
                    <LevelBadge level={level} />
                </div>
                <div className="w-full flex gap-1">
                    {deck.map((_, i) => (
                        <div key={i} className={`h-1.5 flex-1 rounded-full ${
                            i < index
                                ? results[i] === "correct" ? "bg-green-400" : "bg-red-300"
                                : i === index ? "bg-indigo-300" : "bg-gray-200"
                        }`} />
                    ))}
                </div>

                {/* Card */}
                <FlipCard item={card} flipped={flipped} onClick={() => !flipped && setFlipped(true)} />

                {/* Buttons (only after flip) */}
                {flipped ? (
                    <div className="flex gap-3 w-full max-w-sm">
                        <button
                            onClick={() => handleResult("incorrect")}
                            className="flex-1 border-2 border-red-300 text-red-600 font-semibold
                                       rounded-xl py-3 hover:bg-red-50 transition-colors"
                        >
                            ‚úó Not yet
                        </button>
                        <button
                            onClick={() => handleResult("correct")}
                            className="flex-1 border-2 border-green-400 text-green-700 font-semibold
                                       rounded-xl py-3 hover:bg-green-50 transition-colors"
                        >
                            ‚úì Got it
                        </button>
                    </div>
                ) : (
                    <p className="text-sm text-gray-400">Tap the card to flip</p>
                )}
            </main>
        </div>
    )
}
























// pages/VerbDrillPage.tsx
import { useState, useMemo } from "react"
import { useParams } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { QuizCard } from "../components/QuizCard"
import { LevelBadge } from "../components/LevelBadge"
import { Verb } from "../types"

interface DrillQuestion {
    verb: Verb
    tense: string
    pronoun: string
    correct: string
    options: string[]
}

function shuffle<T>(arr: T[]): T[] {
    return [...arr].sort(() => Math.random() - 0.5)
}

function buildQuestions(verbs: Verb[]): DrillQuestion[] {
    // Collect all (verb, tense, form) combos
    const all: Omit<DrillQuestion, "options">[] = []
    for (const verb of verbs) {
        for (const conj of verb.conjugations) {
            for (const form of conj.forms) {
                all.push({ verb, tense: conj.tense, pronoun: form.pronoun, correct: form.form })
            }
        }
    }

    // All unique forms for distractor pool
    const allForms = [...new Set(all.map(q => q.correct))]

    return shuffle(all).slice(0, 10).map(q => {
        const distractors = shuffle(allForms.filter(f => f !== q.correct)).slice(0, 3)
        return { ...q, options: shuffle([q.correct, ...distractors]) }
    })
}

export function VerbDrillPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)

    const questions = useMemo(
        () => buildQuestions(mod?.verbs.filter(v => v.level === level) ?? []),
        [langId, level]
    )

    const [index, setIndex]     = useState(0)
    const [selected, setSelected] = useState<string | null>(null)
    const [revealed, setRevealed] = useState(false)
    const [score, setScore]     = useState(0)
    const [done, setDone]       = useState(false)

    if (!language || !mod) return null

    if (questions.length === 0) {
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Verb Drill" level={level} backTo={`/learn/${langId}`} />
                <div className="flex flex-col items-center justify-center py-24 text-gray-400">
                    <p className="text-4xl mb-3">üöß</p>
                    <p className="font-medium">No verbs to drill at {level} yet</p>
                </div>
            </div>
        )
    }

    function handleSelect(opt: string) {
        setSelected(opt)
        setRevealed(true)
    }

    function handleNext() {
        const newScore = score + (selected === questions[index].correct ? 1 : 0)
        if (index + 1 >= questions.length) {
            setScore(newScore)
            setDone(true)
        } else {
            setScore(newScore)
            setIndex(i => i + 1)
            setSelected(null)
            setRevealed(false)
        }
    }

    function restart() {
        setIndex(0); setScore(0); setSelected(null); setRevealed(false); setDone(false)
    }

    if (done) {
        const pct = Math.round((score / questions.length) * 100)
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Verb Drill" level={level} backTo={`/learn/${langId}`} />
                <main className="max-w-sm mx-auto px-4 py-12 flex flex-col items-center gap-6 text-center">
                    <div className="text-5xl">{pct >= 70 ? "üèÜ" : "üí™"}</div>
                    <h2 className="text-2xl font-bold text-gray-900">Drill complete!</h2>
                    <div className="bg-white rounded-2xl border border-gray-200 p-5 w-full flex justify-around">
                        <div>
                            <p className="text-3xl font-bold text-green-600">{score}</p>
                            <p className="text-xs text-gray-500 mt-1">Correct</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-red-500">{questions.length - score}</p>
                            <p className="text-xs text-gray-500 mt-1">Wrong</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-indigo-600">{pct}%</p>
                            <p className="text-xs text-gray-500 mt-1">Score</p>
                        </div>
                    </div>
                    <button
                        onClick={restart}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                   rounded-xl py-2.5 text-sm transition-colors"
                    >
                        Try again
                    </button>
                </main>
            </div>
        )
    }

    const q = questions[index]

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Verb Drill" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-xl mx-auto px-4 py-8 flex flex-col items-center gap-6">
                <div className="w-full flex items-center justify-between text-sm text-gray-500">
                    <span>Question {index + 1} of {questions.length}</span>
                    <span className="font-medium">Score: {score}</span>
                </div>

                {/* Progress strip */}
                <div className="w-full flex gap-1">
                    {questions.map((_, i) => (
                        <div key={i} className={`h-1.5 flex-1 rounded-full transition-colors ${
                            i < index ? "bg-indigo-500" :
                            i === index ? "bg-indigo-300" : "bg-gray-200"
                        }`} />
                    ))}
                </div>

                {/* Verb context banner */}
                <div className="w-full bg-white rounded-2xl border border-gray-200 px-5 py-3 flex
                                items-center gap-3">
                    <div className="flex-1">
                        <p className="text-xs text-gray-400 uppercase tracking-wide mb-0.5">{q.tense}</p>
                        <p className="font-semibold text-gray-900">
                            {q.verb.infinitive}
                            {q.verb.romanized && (
                                <span className="ml-2 text-sm font-normal text-indigo-500">
                                    {q.verb.romanized}
                                </span>
                            )}
                        </p>
                        <p className="text-sm text-gray-500">{q.verb.meaning}</p>
                    </div>
                    <LevelBadge level={q.verb.level} />
                </div>

                <QuizCard
                    question={`Conjugate for: ${q.pronoun}`}
                    options={q.options}
                    selected={selected}
                    correct={revealed ? q.correct : null}
                    onSelect={handleSelect}
                />

                {revealed && (
                    <button
                        onClick={handleNext}
                        className="w-full max-w-xl bg-indigo-600 hover:bg-indigo-700 text-white
                                   font-semibold rounded-xl py-3 transition-colors"
                    >
                        {index + 1 >= questions.length ? "See results" : "Next"}
                    </button>
                )}
            </main>
        </div>
    )
}














// pages/GrammarDrillPage.tsx
// Format: show the English translation ‚Üí pick the correct native sentence.
// Distractors are drawn from other examples in the current level.
import { useState, useMemo } from "react"
import { useParams } from "react-router-dom"
import { getLanguage } from "../data/languages"
import { getModule } from "../data/modules"
import { getCurrentLevel } from "../store/progress"
import { NavBar } from "../components/NavBar"
import { QuizCard } from "../components/QuizCard"

interface DrillQuestion {
    translation: string
    correct: string
    options: string[]
}

function shuffle<T>(arr: T[]): T[] {
    return [...arr].sort(() => Math.random() - 0.5)
}

function buildQuestions(mod: ReturnType<typeof getModule>, level: string): DrillQuestion[] {
    if (!mod) return []

    // Collect all examples from current-level grammar lessons
    const examples = mod.grammar
        .filter(g => g.level === level)
        .flatMap(g => g.examples)
        .filter((ex, i, arr) =>
            // deduplicate by native text
            arr.findIndex(e => e.native === ex.native) === i
        )

    if (examples.length < 4) return []

    const allNative = examples.map(e => e.native)

    return shuffle(examples).slice(0, 10).map(ex => {
        const distractors = shuffle(allNative.filter(n => n !== ex.native)).slice(0, 3)
        return {
            translation: ex.translation,
            correct: ex.native,
            options: shuffle([ex.native, ...distractors]),
        }
    })
}

export function GrammarDrillPage() {
    const { langId = "" } = useParams()
    const language = getLanguage(langId)
    const mod = getModule(langId)
    const level = getCurrentLevel(langId)

    const questions = useMemo(() => buildQuestions(mod, level), [langId, level])

    const [index, setIndex]       = useState(0)
    const [selected, setSelected] = useState<string | null>(null)
    const [revealed, setRevealed] = useState(false)
    const [score, setScore]       = useState(0)
    const [done, setDone]         = useState(false)

    if (!language || !mod) return null

    if (questions.length === 0) {
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Grammar Drill" level={level} backTo={`/learn/${langId}`} />
                <div className="flex flex-col items-center justify-center py-24 text-gray-400">
                    <p className="text-4xl mb-3">üöß</p>
                    <p className="font-medium">Not enough grammar examples at {level} yet</p>
                </div>
            </div>
        )
    }

    function handleSelect(opt: string) {
        setSelected(opt)
        setRevealed(true)
    }

    function handleNext() {
        const newScore = score + (selected === questions[index].correct ? 1 : 0)
        if (index + 1 >= questions.length) {
            setScore(newScore)
            setDone(true)
        } else {
            setScore(newScore)
            setIndex(i => i + 1)
            setSelected(null)
            setRevealed(false)
        }
    }

    function restart() {
        setIndex(0); setScore(0); setSelected(null); setRevealed(false); setDone(false)
    }

    if (done) {
        const pct = Math.round((score / questions.length) * 100)
        return (
            <div className="min-h-screen bg-gray-50">
                <NavBar title="Grammar Drill" level={level} backTo={`/learn/${langId}`} />
                <main className="max-w-sm mx-auto px-4 py-12 flex flex-col items-center gap-6 text-center">
                    <div className="text-5xl">{pct >= 70 ? "üèÜ" : "üí™"}</div>
                    <h2 className="text-2xl font-bold text-gray-900">Drill complete!</h2>
                    <div className="bg-white rounded-2xl border border-gray-200 p-5 w-full flex justify-around">
                        <div>
                            <p className="text-3xl font-bold text-green-600">{score}</p>
                            <p className="text-xs text-gray-500 mt-1">Correct</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-red-500">{questions.length - score}</p>
                            <p className="text-xs text-gray-500 mt-1">Wrong</p>
                        </div>
                        <div>
                            <p className="text-3xl font-bold text-indigo-600">{pct}%</p>
                            <p className="text-xs text-gray-500 mt-1">Score</p>
                        </div>
                    </div>
                    <button
                        onClick={restart}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                                   rounded-xl py-2.5 text-sm transition-colors"
                    >
                        Try again
                    </button>
                </main>
            </div>
        )
    }

    const q = questions[index]

    return (
        <div className="min-h-screen bg-gray-50">
            <NavBar title="Grammar Drill" level={level} backTo={`/learn/${langId}`} />
            <main className="max-w-xl mx-auto px-4 py-8 flex flex-col items-center gap-6">
                <div className="w-full flex items-center justify-between text-sm text-gray-500">
                    <span>Question {index + 1} of {questions.length}</span>
                    <span className="font-medium">Score: {score}</span>
                </div>

                {/* Progress strip */}
                <div className="w-full flex gap-1">
                    {questions.map((_, i) => (
                        <div key={i} className={`h-1.5 flex-1 rounded-full transition-colors ${
                            i < index ? "bg-indigo-500" :
                            i === index ? "bg-indigo-300" : "bg-gray-200"
                        }`} />
                    ))}
                </div>

                {/* Instruction banner */}
                <div className="w-full bg-amber-50 border border-amber-200 rounded-2xl px-5 py-3 text-center">
                    <p className="text-xs text-amber-600 font-medium uppercase tracking-wide mb-1">
                        Pick the correct translation
                    </p>
                    <p className="text-lg font-semibold text-amber-900">{q.translation}</p>
                </div>

                <QuizCard
                    question="Which sentence matches the meaning above?"
                    options={q.options}
                    selected={selected}
                    correct={revealed ? q.correct : null}
                    onSelect={handleSelect}
                />

                {revealed && (
                    <button
                        onClick={handleNext}
                        className="w-full max-w-xl bg-indigo-600 hover:bg-indigo-700 text-white
                                   font-semibold rounded-xl py-3 transition-colors"
                    >
                        {index + 1 >= questions.length ? "See results" : "Next"}
                    </button>
                )}
            </main>
        </div>
    )
}



